{
    "id": 38136162,
    "contestId": 917,
    "creationTimeSeconds": 1526123204,
    "relativeTimeSeconds": 2147483647,
    "problem": {
        "contestId": 917,
        "index": "E",
        "name": "Upside Down",
        "type": "PROGRAMMING",
        "points": 2750.0,
        "rating": 3400,
        "tags": [
            "data structures",
            "string suffix structures",
            "strings",
            "trees"
        ]
    },
    "author": {
        "contestId": 917,
        "members": [
            {
                "handle": "kut_kjb1994"
            }
        ],
        "participantType": "PRACTICE",
        "ghost": false,
        "startTimeSeconds": 1517236500
    },
    "programmingLanguage": "GNU C++14",
    "verdict": "COMPILATION_ERROR",
    "testset": "TESTS",
    "passedTestCount": 0,
    "timeConsumedMillis": 0,
    "memoryConsumedBytes": 0,
    "source": "#include <bits/stdc++.h>\r\nusing namespace std;\r\n\r\nconst int L = 500;\r\nconst int N = 220000;\r\n\r\nint chd[N][26], go[N][26];\r\nint len[N], q[N], p[N];\r\nint s[N], dp[N], f[17][N], t[N];\r\nchar str[N], _str[N];\r\nint st[N], en[N], wh[N], fr[N], to[N], cur[N], state[N], id[N], ans[N], cnt[N], sum[N], chk[N], a[N], b[N];\r\nint h1[N], h2[N], hh1[N], hh2[N], hs1[N], hs2[N], p1[N], p2[N];\r\nvector<int> adj[N], con[N];\r\nint sn, e[N];\r\nchar w[N], ch[N];\r\n\r\nvoid dfs(int u, int p) {\r\n\ts[u] = sn;\r\n\tf[0][u] = p;\r\n\tdp[u] = dp[p] + 1;\r\n\tfor (int i = 1; i < 17; i++) f[i][u] = f[i-1][f[i-1][u]];\r\n\tfor (int tt : adj[u]) {\r\n\t\tint v = e[tt] ^ u;\r\n\t\tif (v == p) continue;\r\n\t\tch[v] = w[tt];\r\n\t\ta[sn] = u, b[sn] = v;\r\n\t\tt[sn++] = tt;\r\n\t\tdfs(v, u);\r\n\t\ta[sn] = v, b[sn] = u;\r\n\t\tt[sn++] = tt;\r\n\t}\r\n}\r\n\r\nint T;\r\nvoid dfs(int u) {\r\n\tst[u] = ++T;\r\n\tfor (int v : con[u]) {\r\n\t\tdfs(v);\r\n\t}\r\n\ten[u] = T;\r\n}\r\n\r\nvoid modify(int x, int y) {\r\n\tcnt[x] += y;\r\n\tsum[x / L] += y;\r\n}\r\n\r\nint query(int l, int r) {\r\n\tint ll = l / L, rr = r / L;\r\n\tint ret = 0;\r\n\tif (ll == rr) {\r\n\t\tfor (int i = l; i <= r; i++) ret += cnt[i];\r\n\t\treturn ret;\r\n\t}\r\n\tfor (int i = l; i < min((ll+1)*L, r+1); i++) ret += cnt[i];\r\n\tfor (int i = max(l, rr*L); i <= r; i++) ret += cnt[i];\r\n\tfor (int i = ll+1; i < rr; i++) ret += sum[i];\r\n\treturn ret;\r\n}\r\n\r\nint lca(int u, int v) {\r\n\tif (dp[u] < dp[v]) swap(u, v);\r\n\tfor (int d = dp[u] - dp[v], i = 0; i < 17; i++) if (d >> i & 1) u = f[i][u];\r\n\tif (u == v) return u;\r\n\tfor (int i = 16; i >= 0; i--) {\r\n\t\tif (f[i][u] == f[i][v]) continue;\r\n\t\tu = f[i][u], v = f[i][v];\r\n\t}\r\n\treturn f[0][u];\r\n}\r\n\r\nint n, m, Q;\r\n\r\nconst int B1 = 31;\r\nconst int B2 = 47;\r\n\r\npair<int, int> get(int *h1, int *h2, int l, int s, int e) {\r\n\treturn make_pair(h1[e+1] - h1[s] * p1[e - s + 1], h2[e+1] - h2[s] * p2[e - s + 1]);\r\n}\r\n\r\nint make_path(int u, int v) {\r\n\tint p = lca(u, v);\r\n\tint ret = 0;\r\n\twhile (u != p) {\r\n\t\t_str[ret++] = ch[u];\r\n\t\tu = f[0][u];\r\n\t}\r\n\tint nret = ret;\r\n\twhile (v != p) {\r\n\t\t_str[ret++] = ch[v];\r\n\t\tv = f[0][v];\r\n\t}\r\n\treverse(_str + nret, _str + ret);\r\n\tfor (int i = 0; i < ret; i++) {\r\n\t\thh1[i+1] = hh1[i] * B1 + _str[i] - 'a';\r\n\t\thh2[i+1] = hh2[i] * B2 + _str[i] - 'a';\r\n\t}\r\n\treturn ret;\r\n}\r\n\r\nint dist(int u, int v) {\r\n\treturn dp[u] + dp[v] - 2 * dp[lca(u, v)];\r\n}\r\n\r\nint main() {\r\n#ifndef ONLINE_JUDGE\r\n\tfreopen(\"in.txt\", \"r\", stdin);\r\n\tfreopen(\"out.txt\", \"w\", stdout);\r\n#endif\r\n\tscanf(\"%d%d%d\", &n, &m, &Q);\r\n\tfor (int i = 1; i < n; i++) {\r\n\t\tint u, v; char c[3]; scanf(\"%d%d%s\", &u, &v, c);\r\n\t\te[i] = u ^ v; w[i] = c[0];\r\n\t\tadj[u].push_back(i);\r\n\t\tadj[v].push_back(i);\r\n\t}\r\n\tdfs(1, 0);\r\n\tint nodes = 1;\r\n\tfor (int i = 0; i < N; i++) p1[i] = (i == 0 ? 1 : p1[i-1] * B1), p2[i] = (i == 0 ? 1 : p2[i-1] * B2);\r\n\tfor (int i = 1; i <= m; i++) {\r\n\t\tscanf(\"%s\", str);\r\n\t\tint l = strlen(str);\r\n\t\tfor (int k = 0; k < 2; k++) {\r\n\t\t\tint u = 1, ret1 = 0, ret2 = 0;\r\n\t\t\tfor (int j = 0; str[j]; j++) {\r\n\t\t\t\tint c = str[j] - 'a';\r\n\t\t\t\tret1 = ret1 * B1 + c, ret2 = ret2 * B2 + c;\r\n\t\t\t\tint &v = chd[u][c];\r\n\t\t\t\tif (!v) v = ++nodes;\r\n\t\t\t\tu = v;\r\n\t\t\t}\r\n\t\t\ths1[k * m + i] = ret1;\r\n\t\t\ths2[k * m + i] = ret2;\r\n\t\t\tstate[k * m + i] = u;\r\n\t\t\treverse(str, str + l);\r\n\t\t}\r\n\t\tlen[i] = len[i + m] = l;\r\n\t}\r\n\tint qn = 0;\r\n\tfor (int i = 0, u; i < 26; i++) if (u = chd[1][i]) q[qn++] = u, p[u] = 1;\r\n\tfor (int i = 0; i < qn; i++) {\r\n\t\tint u = q[i];\r\n\t\tfor (int j = 0, v; j < 26; j++) if (v = chd[u][j]) {\r\n\t\t\tint w = p[u];\r\n\t\t\twhile (w > 1 && !chd[w][j]) w = p[w];\r\n\t\t\tw = max(1, chd[w][j]);\r\n\t\t\tp[v] = w;\r\n\t\t\tq[qn++] = v;\r\n\t\t}\r\n\t}\r\n\tfor (int i = 0; i < 26; i++) go[1][i] = max(1, chd[1][i]);\r\n\tfor (int i = 0; i < qn; i++) {\r\n\t\tint u = q[i];\r\n\t\tfor (int j = 0; j < 26; j++) {\r\n\t\t\tif (chd[u][j]) go[u][j] = chd[u][j];\r\n\t\t\telse go[u][j] = go[p[u]][j];\r\n\t\t}\r\n\t}\r\n\tfor (int i = 2; i <= nodes; i++) con[p[i]].push_back(i);\r\n\tdfs(1);\r\n\tfor (int i = 1; i <= Q; i++) {\r\n\t\tscanf(\"%d%d%d\", &fr[i], &to[i], &wh[i]);\r\n\t\tif (s[fr[i]] > s[to[i]]) {\r\n\t\t\tswap(fr[i], to[i]);\r\n\t\t\twh[i] += m;\r\n\t\t}\r\n\t\tfr[i] = s[fr[i]];\r\n\t\tto[i] = s[to[i]] - 1;\r\n\t\tid[i] = i;\r\n\t}\r\n\tsort(id + 1, id + Q + 1, [](int i, int j) {\r\n\t\tif (fr[i] / L != fr[j] / L) return fr[i] / L < fr[j] / L;\r\n\t\treturn to[i] < to[j];\r\n\t});\r\n\tfor (int i = 1, j; i <= Q; i = j) {\r\n\t\tint u = id[i];\r\n\t\tint r = fr[u] / L * L - 1;\r\n\t\tmemset(chk, 0, sizeof chk);\r\n\t\tmemset(cnt, 0, sizeof cnt);\r\n\t\tmemset(sum, 0, sizeof sum);\r\n\t\tint rn = 0;\r\n\t\tcur[0] = 1;\r\n\t\tfor (j = i; j <= Q && fr[id[i]] / L == fr[id[j]] / L; j++) {\r\n\t\t\tint v = id[j];\r\n\t\t\twhile (r < to[v]) {\r\n\t\t\t\t++r;\r\n\t\t\t\tint eid = t[r];\r\n\t\t\t\tint c = w[eid] - 'a';\r\n\t\t\t\tif (chk[eid]) {\r\n\t\t\t\t\tmodify(st[cur[rn]], -1);\r\n\t\t\t\t\trn--;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcur[rn+1] = go[cur[rn]][c];\r\n\t\t\t\t\th1[rn+1] = h1[rn] * B1 + c;\r\n\t\t\t\t\th2[rn+1] = h2[rn] * B2 + c;\r\n\t\t\t\t\tmodify(st[cur[++rn]], 1);\r\n\t\t\t\t}\r\n\t\t\t\tchk[eid] ^= 1;\r\n\t\t\t}\r\n\t\t\tint who = wh[v];\r\n\t\t\tans[v] = query(st[state[who]], en[state[who]]);\r\n\t\t\tint xx = a[fr[u] / L * L];\r\n\t\t\tint yy = a[fr[v]];\r\n\t\t\tint zz = b[r];\r\n\t\t\tint pxy = lca(xx, yy);\r\n\t\t\tint pyz = lca(yy, zz);\r\n\t\t\tint pzx = lca(zz, xx);\r\n\t\t\tint pp = pxy ^ pyz ^ pzx;\r\n\t\t\tint xy = dp[xx] + dp[yy] - 2 * dp[pxy];\r\n\t\t\tint yz = dp[zz] + dp[yy] - 2 * dp[pyz];\r\n\t\t\tint zx = dp[xx] + dp[zz] - 2 * dp[pzx];\r\n\t\t\tint xlen = (xy + zx - yz) / 2;\r\n\t\t\tassert(xlen == dist(xx, pp));\r\n\t\t\tassert(rn == xz);\r\n\t\t\tfor (int k = 0; k < xlen; k++) {\r\n\t\t\t\tif (k + len[who] - 1 >= rn) break;\r\n\t\t\t\tauto ret = get(h1, h2, rn, k, k + len[who] - 1);\r\n\t\t\t\tif (ret.first == hs1[who] && ret.second == hs2[who]) ans[v]--;\r\n\t\t\t}\r\n\t\t\tint ylen = make_path(yy, pp);\r\n\t\t\tfor (int k = 0; k < ylen; k++) {\r\n\t\t\t\tif (k + len[who] - 1 < ylen) {\r\n\t\t\t\t\tauto ret = get(hh1, hh2, ylen, k, k + len[who] - 1);\r\n\t\t\t\t\tif (ret.first == hs1[who] && ret.second == hs2[who]) ans[v]++;\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\tif (len[who] - ylen + k > rn - xlen) break;\r\n\t\t\t\tauto first = get(hh1, hh2, ylen, k, ylen-1);\r\n\t\t\t\tauto second = get(h1, h2, rn, xlen, xlen + len[who] - (ylen - k) - 1);\r\n\t\t\t\tint ret1 = first.first * p1[len[who] - (ylen - k)] + second.first;\r\n\t\t\t\tint ret2 = first.second * p2[len[who] - (ylen - k)] + second.second;\r\n\t\t\t\tif (ret1 == hs1[who] && ret2 == hs2[who]) ans[v]++;\r\n\t\t\t}\r\n\t\t\tif (m == 6 && n == 1e5 && Q == 1e5 && v == 18 && ans[v] == 4) {\r\n\t\t\t\tassert(xlen <= xz);\r\n//\t\t\t\tassert(len[wh[v]] <= 500);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tfor (int i = 1; i <= Q; i++) printf(\"%d\\n\", ans[i]);\r\n\treturn 0;\r\n}\r\n\n                                                                                                                                                                    "
}