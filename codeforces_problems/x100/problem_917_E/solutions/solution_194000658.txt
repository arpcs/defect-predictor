{
    "id": 194000658,
    "contestId": 917,
    "creationTimeSeconds": 1676643848,
    "relativeTimeSeconds": 2147483647,
    "problem": {
        "contestId": 917,
        "index": "E",
        "name": "Upside Down",
        "type": "PROGRAMMING",
        "points": 2750.0,
        "rating": 3400,
        "tags": [
            "data structures",
            "string suffix structures",
            "strings",
            "trees"
        ]
    },
    "author": {
        "contestId": 917,
        "members": [
            {
                "handle": "tuxiaoxiao"
            }
        ],
        "participantType": "PRACTICE",
        "ghost": false,
        "startTimeSeconds": 1517236500
    },
    "programmingLanguage": "GNU C++17 (64)",
    "verdict": "OK",
    "testset": "TESTS",
    "passedTestCount": 118,
    "timeConsumedMillis": 1372,
    "memoryConsumedBytes": 407244800,
    "source": "#include<bits/stdc++.h>\r\n#define f(i,l,r) for(int i=l;i<=r;i++)\r\n#define df(i,l,r) for(int i=l;i>=r;i--)\r\n#define pb push_back\r\n#define F first\r\n#define S second\r\n#define ull unsigned long long\r\nusing namespace std;\r\nconst int N=6e5+10;\r\nint m,n,qry,i,x,y,t,a[N],aa[N],rk[N],ti,lc,nx[N],fa1[N][18],sa[N],se[N],in[N],jpd[20],jpl[20],l1[N],jl,ll,rr,md,out[N],tr1[N],d[N],da[N],f[N],fa[N][18],l[N],k,j,tr[N][27],id[N],hi[N],st[N],ed[N],L,len,tot,u,v,fl[N];\r\null g[N][18],pw[N],H=19260817,hs[N];\r\nchar s[N],ch;\r\nvector<pair<int,int> >b[N],q1[N],q3[N];\r\nvector<pair<pair<pair<int,int> ,pair<int,int> > ,int> >q2[N];\r\nvector<int>b1[N],hv[N];\r\nqueue<int>q;\r\nvoid A(int e,int k){while(e<=ti+9)tr1[e]+=k,e+=e&-e;}\r\nint Q(int e){int k=0;while(e)k+=tr1[e],e-=e&-e;return k;}\r\null HS(int l,int r){return hs[r]-hs[l-1]*pw[r-l+1];}\r\nvoid srt()\r\n{\r\n\tf(i,0,L+26)f[i]=0;\r\n\tf(i,1,L)f[rk[i]]++;\r\n\tf(i,1,L+26)f[i]+=f[i-1];\r\n\tdf(i,L,1)sa[f[rk[se[i]]]--]=se[i];\r\n}\r\nint zx(int u,int v){f(i,0,16)if(v>>i&1)u=fa[u][i];return u;}\r\nint lca(int u,int v)\r\n{\r\n\tif(d[u]<d[v])swap(u,v);u=zx(u,d[u]-d[v]);\r\n\tdf(k,16,0)if(fa[u][k]!=fa[v][k])u=fa[u][k],v=fa[v][k];\r\n\treturn (u==v)?u:fa[u][0];\r\n}\r\nvoid D(int e)\r\n{\r\n\tin[e]=++ti;\r\n\tfor(int u:b1[e])D(u);\r\n\tout[e]=ti;\r\n}\r\nvoid D1(int e)\r\n{\r\n\tf(i,1,16)fa[e][i]=fa[fa[e][i-1]][i-1],g[e][i]=g[fa[e][i-1]][i-1]*pw[1<<i-1]+g[e][i-1];\r\n\tfor(auto u:b[e])if(u.F!=fa[e][0])fa[u.F][0]=e,g[u.F][0]=u.S,d[u.F]=d[e]+1,D1(u.F);\r\n}\r\nvoid Q1(int e,int v)\r\n{//cout<<e<<v<<' ';\r\n\tA(in[v],1);\r\n\tfor(auto u:q1[e])da[abs(u.S)]+=(u.S<0?-1:1)*(Q(out[u.F])-Q(in[u.F]-1));//,cout<<u.S<<Q(out[u.F])-Q(in[u.F]-1);\r\n\tfor(auto u:b[e])if(u.F!=fa[e][0])Q1(u.F,tr[v][u.S]);\r\n\tA(in[v],-1);\r\n}\r\nvoid Q2(int e)\r\n{//cout<<e;\r\n\tif(e&&e!=len)A(in[len-e],1),A(out[len-e]+1,-1);\r\n\tfor(auto u:q3[e])da[u.S]+=Q(in[u.F]);\r\n\tfor(auto u:b1[e])Q2(u);\r\n\tif(e&&e!=len)A(in[len-e],-1),A(out[len-e]+1,1);\r\n}\r\nint sm(int x,int y,int md)\r\n{\r\n\tint z=0;jl=0;\r\n\tif(d[x]-d[y]>L-sa[md]+1)x=zx(x,d[x]-d[y]-(L-sa[md]+1));\r\n\tdf(i,16,0)if(d[x]-d[y]>>i&1)jpd[++jl]=x,jpl[jl]=i,x=fa[x][i];//,cout<<jl<<HS(sa[md],sa[md])<<' ';\r\n\tdf(i,jl,1)if(g[jpd[i]][jpl[i]]==HS(sa[md]+z,sa[md]+z+(1<<jpl[i])-1))z+=1<<jpl[i];\r\n\telse\r\n\t{//cout<<z;\r\n\t\tdf(j,jpl[i]-1,0)\r\n\t\tif(g[fa[jpd[i]][j]][j]==HS(sa[md]+z,sa[md]+z+(1<<j)-1))z+=1<<j;\r\n\t\telse jpd[i]=fa[jpd[i]][j];\r\n\t\tbreak;\r\n\t}\r\n\treturn z;\r\n}\r\nbool co(int x,int y)//y->x\u94fe>=md\r\n{\r\n\tint z=sm(x,y,md);\r\n\tif(z==d[x]-d[y]||sa[md]+z-1==L)return 1;\r\n\treturn g[zx(x,d[x]-d[y]-z-1)][0]>a[sa[md]+z];\r\n}\r\nint main()\r\n{\r\n\tscanf(\"%d%d%d\",&n,&m,&qry);\r\n\tpw[0]=1;f(i,1,100000)pw[i]=pw[i-1]*H;\r\n\tf(i,1,n-1){scanf(\"%d%d\",&x,&y);ch=getchar();while(!isalpha(ch))ch=getchar();b[x].pb({y,ch-'a'});b[y].pb({x,ch-'a'});}\r\n\tf(i,1,m)\r\n\t{\r\n\t\tscanf(\"%s\",s);l[i]=len=strlen(s);\r\n\t\tu=0;st[i*2-1]=L+1;\r\n\t\tf(j,1,len){if(!tr[u][rk[++L]=v=s[j-1]-'a'])tr[u][v]=++tot;id[L]=u=tr[u][v];}\r\n\t\ted[i*2-1]=L;rk[++L]=26;//cout<<L<<id[L];\r\n\t\treverse(s,s+len);\r\n\t\tu=0;st[i*2]=L+1;\r\n\t\tf(j,1,len){if(!tr[u][rk[++L]=v=s[j-1]-'a'])tr[u][v]=++tot;id[L]=u=tr[u][v];}\r\n\t\ted[i*2]=L;rk[++L]=26;\r\n\t}\r\n\tf(i,1,L)se[i]=i,a[i]=rk[i],hs[i]=hs[i-1]*H+rk[i];////////\r\n\tsrt();\r\n\tfor(int t=1,p=0;p<L;t<<=1)\r\n\t{\r\n\t\tf(i,1,t)se[i]=L-i+1;\r\n\t\tp=t;f(i,1,L)if(sa[i]>t)se[++p]=sa[i]-t;\r\n\t\tsrt();\r\n\t\tswap(rk,se);\r\n\t\trk[sa[1]]=p=1;\r\n\t\tf(i,2,L)rk[sa[i]]=(se[sa[i]]==se[sa[i-1]]&&se[sa[i]+t]==se[sa[i-1]+t])?p:++p;\r\n\t}\r\n//\tfor(i=1,k=0;i<=L;hi[rk[i++]]=k)\r\n//\tfor(k?k--:0,j=sa[rk[i]-1];s[i+k-1]==s[j+k-1];k++);\r\n\tf(i,1,L)if(a[sa[i]]!=26)hv[lower_bound(ed+1,ed+m*2+1,sa[i])-ed].pb(i);\r\n\tf(i,0,25)if(tr[0][i])q.push(tr[0][i]),l1[tr[0][i]]=1;\r\n\twhile(!q.empty())\r\n\t{\r\n\t\tu=q.front();q.pop();b1[fl[u]].push_back(u);\r\n\t\tfa1[u][0]=fl[u];f(i,1,16)fa1[u][i]=fa1[fa1[u][i-1]][i-1];\r\n\t\tf(i,0,25)if(tr[u][i])fl[tr[u][i]]=tr[fl[u]][i],l1[tr[u][i]]=l1[u]+1,q.push(tr[u][i]);\r\n\t\telse tr[u][i]=tr[fl[u]][i];\r\n\t}\r\n\tD(0);\r\n\td[1]=1;D1(1);\r\n\t//md=1;cout<<co(3,1);\r\n\tf(i,1,qry)//if(qry==1000&&i==151)cout<<x<<' '<<y<<' '<<t<<' ';\r\n\t{\r\n\t\tint z=0,w=0,len1;\r\n\t\tscanf(\"%d%d%d\",&x,&y,&t);lc=lca(x,y);//cout<<id[ed[t*2-1]];\r\n\t\tif(d[x]-d[lc]>=l[t])q1[x].pb({id[ed[t*2]],i}),q1[zx(x,d[x]-d[lc]-(l[t]-1))].pb({id[ed[t*2]],-i});\r\n\t\tif(d[y]-d[lc]>=l[t])q1[y].pb({id[ed[t*2-1]],i}),q1[zx(y,d[y]-d[lc]-(l[t]-1))].pb({id[ed[t*2-1]],-i});\r\n\t\tll=0,rr=L;\r\n\t\twhile(ll<rr)\r\n\t\t{\r\n\t\t\tmd=ll+rr+1>>1;\r\n\t\t\tif(co(x,lc))ll=md;else rr=md-1;\r\n\t\t}\r\n\t\tauto it=lower_bound(hv[t*2].begin(),hv[t*2].end(),ll);\r\n\t\tif(it!=hv[t*2].end()){z=*it;++it;if(it!=hv[t*2].end()&&sm(x,lc,*it)>sm(x,lc,z))z=*it;--it;}\r\n\t\tif(it!=hv[t*2].begin()){--it;if(!z||sm(x,lc,*it)>sm(x,lc,z))z=*it;++it;}\r\n//\t\tcout<<sm(6,1,7);\r\n\t\tlen=min(sm(x,lc,z),l[t]-1);z=ed[t*2]-sa[z]+1;if(!len)continue;//cout<<z;\r\n\t\tlen1=len;\r\n//\t\tdf(j,16,0)if(l1[fa1[z][j]]>=len)z=fa1[z][j];\r\n//\t\tif(l1[z]>len)z=fa1[z][0];\r\n\t\tll=0,rr=L;\r\n\t\twhile(ll<rr)\r\n\t\t{\r\n\t\t\tmd=ll+rr+1>>1;\r\n\t\t\tif(co(y,lc))ll=md;else rr=md-1;\r\n\t\t}\r\n\t\tit=lower_bound(hv[t*2-1].begin(),hv[t*2-1].end(),ll);//cout<<*it;\r\n\t\tif(it!=hv[t*2-1].end()){w=*it;++it;if(it!=hv[t*2-1].end()&&sm(y,lc,*it)>sm(y,lc,w))w=*it;--it;}\r\n\t\tif(it!=hv[t*2-1].begin()){--it;if(!w||sm(y,lc,*it)>sm(y,lc,w))w=*it;++it;}\r\n\t\tlen=min(sm(y,lc,w),l[t]-1);w=ed[t*2-1]-sa[w]+1;if(!len)continue;\r\n//\t\tdf(j,16,0)if(l1[fa1[w][j]]>=len)w=fa1[w][j];\r\n//\t\tif(l1[w]>len)w=fa1[w][0];\r\n\t\tq2[t].pb({{{z,len1},{w,len}},i});//cout<<l1[z]<<l1[w];\r\n\t}\r\n\tQ1(1,0);//cout<<da[1];\r\n\tf(k,1,m)\r\n\t{\r\n\t\tint j=0;len=l[k];\r\n\t\tf(i,st[k*2],ed[k*2])aa[i-st[k*2]+1]=a[i];\r\n\t\tf(i,0,l[k])nx[i]=0,q3[i].clear(),b1[i].clear();\r\n\t\tb1[0].pb(1);\r\n\t\tf(i,2,l[k])\r\n\t\t{\r\n\t\t\twhile(j&&aa[i]!=aa[j+1])j=nx[j];\r\n\t\t\tif(aa[i]==aa[j+1])++j;\r\n\t\t\tnx[i]=j;b1[nx[i]].pb(i);\r\n\t\t\tfa1[i][0]=nx[i];f(j,1,16)fa1[i][j]=fa1[fa1[i][j-1]][j-1];\r\n\t\t}\r\n\t\tfor(int i=0;i<q2[k].size();i++)\r\n\t\t{\r\n\t\t\tauto u=q2[k][i].F.S;//\r\n\t\t\tdf(j,16,0)if(fa1[u.F][j]>=u.S)u.F=fa1[u.F][j];\r\n\t\t\tif(u.F>u.S)u.F=fa1[u.F][0];//cout<<u.F<<u.S;\r\n\t\t\tq2[k][i].F.S=u;\r\n\t\t}\r\n\t\tti=0;D(0);\r\n\t\treverse(aa+1,aa+l[k]+1);\r\n\t\tf(i,0,l[k])nx[i]=0,b1[i].clear();\r\n\t\tb1[0].pb(1);\r\n\t\tj=0;\r\n\t\tf(i,2,l[k])\r\n\t\t{\r\n\t\t\twhile(j&&aa[i]!=aa[j+1])j=nx[j];\r\n\t\t\tif(aa[i]==aa[j+1])++j;\r\n\t\t\tnx[i]=j;b1[nx[i]].pb(i);\r\n\t\t\tfa1[i][0]=nx[i];f(j,1,16)fa1[i][j]=fa1[fa1[i][j-1]][j-1];\r\n\t\t}\r\n\t\tfor(int i=0;i<q2[k].size();i++)\r\n\t\t{\r\n\t\t\tauto u=q2[k][i].F.F;//\r\n\t\t\tdf(j,16,0)if(fa1[u.F][j]>=u.S)u.F=fa1[u.F][j];\r\n\t\t\tif(u.F>u.S)u.F=fa1[u.F][0];//cout<<u.F<<u.S;\r\n\t\t\tq2[k][i].F.F=u;\r\n\t\t}\r\n\t\tfor(auto u:q2[k])q3[u.F.F.F].pb({u.F.S.F,u.S});\r\n\t\tQ2(0);\r\n\t}\r\n\tf(i,1,qry)cout<<da[i]<<'\\n';\r\n\treturn 0;\r\n}"
}