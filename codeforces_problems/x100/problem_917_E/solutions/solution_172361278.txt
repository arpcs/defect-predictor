{
    "id": 172361278,
    "contestId": 917,
    "creationTimeSeconds": 1663339898,
    "relativeTimeSeconds": 2147483647,
    "problem": {
        "contestId": 917,
        "index": "E",
        "name": "Upside Down",
        "type": "PROGRAMMING",
        "points": 2750.0,
        "rating": 3400,
        "tags": [
            "data structures",
            "string suffix structures",
            "strings",
            "trees"
        ]
    },
    "author": {
        "contestId": 917,
        "members": [
            {
                "handle": "grass8sheep"
            }
        ],
        "participantType": "PRACTICE",
        "ghost": false,
        "startTimeSeconds": 1517236500
    },
    "programmingLanguage": "GNU C++14",
    "verdict": "WRONG_ANSWER",
    "testset": "TESTS",
    "passedTestCount": 5,
    "timeConsumedMillis": 592,
    "memoryConsumedBytes": 68403200,
    "source": "#include<bits/stdc++.h>\r\nusing namespace std;\r\nconst int G=137,mod=1e9+7;\r\nint qpow(int a,int b){\r\n\tint c=1;\r\n\tfor(;b;b>>=1){\r\n\t\tif(b&1)c=1ll*a*c%mod;\r\n\t\ta=1ll*a*a%mod;\r\n\t}\r\n\treturn c;\r\n}\r\nint E[101000],EI[101000];\r\nstruct ed{int v;char c;};\r\nvector<ed>g[101000];\r\nint f[101000][20],ds[101000],d[100100];\r\nchar cnc[101000];\r\nvoid dfs(int x){\r\n\tfor(ed t:g[x])if(t.v!=f[x][0]){\r\n\t\tint v=t.v;cnc[v]=t.c;\r\n\t\tf[v][0]=x,d[v]=d[x]+1,ds[v]=(ds[x]+1ll*((int)t.c)*E[d[x]]%mod)%mod;\r\n\t\tfor(int i=1;i<18;i++)f[v][i]=f[f[v][i-1]][i-1];\r\n\t\tdfs(v);\r\n\t}\r\n}\r\nint lca(int u,int v){\r\n\tif(d[u]<d[v])swap(u,v);int a=d[u]-d[v];\r\n\tfor(int i=17;i>=0;i--)if((a>>i)&1)u=f[u][i];\r\n\tif(u==v)return u;\r\n\tfor(int i=17;i>=0;i--)if(f[u][i]!=f[v][i])u=f[u][i],v=f[v][i];\r\n\treturn f[u][0];\r\n}\r\nint kth(int u,int k){\r\n\tfor(int i=17;i>=0;i--)if((k>>i)&1)u=f[u][i];\r\n\treturn u;\r\n}\r\nstruct AC{\r\n\tint dfn[100010],sz[100010],cn,ch[101000][26],fail[101000];\r\n\tvector<int>g[101000];\r\n\tinline void init(int &u,char *c,int L){\r\n\t\tu=1;\r\n\t\tfor(int i=1;i<=L;i++){\r\n\t\t\tint p=c[i]-'a';\r\n\t\t\tif(!ch[u][p])ch[u][p]=++cn;\r\n\t\t\tu=ch[u][p];\r\n\t\t}\r\n\t}\r\n\tint tr[101000];\r\n\tinline void ad(int x,int z){for(x=dfn[x];x<=cn;x+=(x&-x))tr[x]+=z;}\r\n\tinline int ask(int u){\r\n\t\tint s=0;\r\n\t\tfor(int x=dfn[u]+sz[u]-1;x;x-=(x&-x))s+=tr[x];\r\n\t\tfor(int x=dfn[u]-1;x;x-=(x&-x))s-=tr[x];\r\n\t\treturn s;\r\n\t}\r\n\tinline void dfs(int x){\r\n\t\tsz[x]=1;dfn[x]=++dfn[0];\r\n\t\tfor(int v:g[x])dfs(v),sz[x]+=sz[v];\r\n\t}\r\n\tinline void build(){\r\n\t\tqueue<int>q;\r\n\t\tfor(int i=0;i<26;i++)if(!ch[1][i])ch[1][i]=1;else fail[ch[1][i]]=1,q.push(ch[1][i]);\r\n\t\twhile(!q.empty()){\r\n\t\t\tint u=q.front();q.pop();\r\n\t\t\tfor(int i=0;i<26;i++)if(!ch[u][i])ch[u][i]=ch[fail[u]][i];\r\n\t\t\telse fail[ch[u][i]]=ch[fail[u]][i],q.push(ch[u][i]);\r\n\t\t}\r\n\t\tfor(int i=2;i<=cn;i++)g[fail[i]].push_back(i);\r\n\t\tdfs(1);\r\n\t}\r\n}T1,T2;\r\nint id1[101000],id2[101000],L[101000],R[101000];//\u4e32 \r\nint U[101000],V[100010],ans[101000],W[101000],lc[101000];//\u95ee \r\nstruct com{int id,ty1,ty2;};\r\nvector<com>op[101000];\r\nvoid dfs2(int x,int u1,int u2){\r\n\tT1.ad(u1,1),T2.ad(u2,1);\r\n\tfor(com t:op[x]){\r\n\t\tif(t.ty1==1)ans[t.id]+=T1.ask(id1[W[t.id]])*t.ty2;\r\n\t\telse ans[t.id]+=T2.ask(id2[W[t.id]])*t.ty2;\r\n\t}\r\n\tfor(ed t:g[x])if(t.v!=f[x][0]){\r\n\t\tint v=t.v,p=t.c-'a';\r\n\t\tdfs2(v,T1.ch[u1][p],T2.ch[u2][p]);\r\n\t}\r\n\tT1.ad(u1,-1),T2.ad(u2,-1);\r\n}\r\nstruct syz{int x,y,z;};\r\nstruct cosplay{\r\n\tint sa[400100],rk[400100],tr[400100],t[401000],m,n;\r\n\tint kmp[101000],xs[101000],hx[101000];\r\n\tchar c[100010];\r\n\tinline void init(char *P,int L){\r\n\t\tn=L;for(int i=1;i<=n;i++)c[i]=P[i];\r\n\t\tkmp[1]=0;\r\n\t\treverse(c+1,c+n+1);\r\n\t\tfor(int i=2,j=0;i<=n;i++){\r\n\t\t\twhile(j&&c[j+1]==c[i])j=kmp[j];\r\n\t\t\tif(c[j+1]==c[i])j++;kmp[i]=j;\r\n\t\t}\r\n\t\tfor(int i=1;i<=n;i++){\r\n\t\t\tif(!kmp[i])xs[i]=1;\r\n\t\t\telse if(xs[kmp[i]]==1||i-kmp[i]==kmp[i]-kmp[kmp[i]])xs[i]=xs[kmp[i]]+1;\r\n\t\t\telse xs[i]=1;\r\n\t\t}\r\n\t\treverse(c+1,c+n+1);\r\n\t\tm=128;\r\n\t\tfor(int i=1;i<=m;i++)t[i]=0;\r\n\t\tfor(int i=1;i<=n;i++)t[rk[i]=c[i]]++;\r\n\t\tfor(int i=1;i<=m;i++)t[i]+=t[i-1];\r\n\t\tfor(int i=1;i<=n;i++)sa[t[rk[i]]--]=i;\r\n\t\tfor(int k=1;;k++){\r\n\t\t\tint o=0;\r\n\t\t\tfor(int i=n-k+1;i<=n;i++)tr[++o]=i;\r\n\t\t\tfor(int i=1;i<=n;i++)if(sa[i]>k)tr[++o]=sa[i]-k;\r\n\t\t\tfor(int i=1;i<=m;i++)t[i]=0;\r\n\t\t\tfor(int i=1;i<=n;i++)t[rk[i]]++;\r\n\t\t\tfor(int i=1;i<=m;i++)t[i]+=t[i-1];\r\n\t\t\tfor(int i=1;i<=n;i++)sa[t[rk[tr[i]]]--]=tr[i];\r\n\t\t\tswap(tr,rk);o=rk[sa[1]]=1;\r\n\t\t\tfor(int i=2;i<=n;i++)rk[sa[i]]=((tr[sa[i-1]]==tr[sa[i]]&&tr[sa[i-1]+k]==tr[sa[i]+k])?o:(++o));\r\n\t\t\tif(o==n)break;m=o;\r\n\t\t}\r\n\t\tfor(int i=1;i<=n;i++)hx[i]=(hx[i-1]+1ll*E[i]*((int)c[i])%mod)%mod;\t\r\n\t}\r\n\tinline bool cmp(int id,int u,int F,int &x){\r\n\t\tint le=d[u]-d[F];\r\n\t\tif(le<=n-id+1&&(1ll*(hx[id+le-1]-hx[id-1])*EI[id]%mod+mod)%mod==(1ll*(ds[u]-ds[F])*EI[d[F]]%mod+mod)%mod){x=le;return (le==n-id+1);}\r\n\t\tfor(int i=17;i>=0;i--)if(d[u]-(1<<i)>d[F]){\r\n\t\t\tint le=d[u]-(1<<i)-d[F];\r\n\t\t\tif(le<=n-id+1&&(1ll*(hx[id+le-1]-hx[id-1])*EI[id]%mod+mod)%mod==(1ll*(ds[f[u][i]]-ds[F])*EI[d[F]]%mod+mod)%mod);\r\n\t\t\telse u=f[u][i];\r\n\t\t}\r\n\t\tx=d[u]-d[F]-1;\r\n\t\tif(id+x>n||c[id+x]<=cnc[u])return 1;\r\n\t\treturn 0;\r\n\t}\r\n\tinline vector<syz>ask(int u,int f){\r\n\t\tint l=1,r=n,id=0;\r\n\t\twhile(l<=r){\r\n\t\t\tint mid=(l+r)>>1,hh;\r\n\t\t\tif(cmp(sa[mid],u,f,hh))id=mid,l=mid+1;\r\n\t\t\telse r=mid-1;\r\n\t\t}\r\n\t\tvector<syz>ans;\r\n\t\tint lcc;\r\n\t\tif(id==n)return ans;\r\n\t\tid++;\r\n\t\tcmp(sa[id],u,f,lcc);\r\n\t\tid=n-sa[id]+1;\r\n\t\twhile(id>lcc)id=kmp[id];\r\n\t\twhile(id){\r\n\t\t\tans.push_back((syz){id,xs[id],id-kmp[id]});\r\n\t\t\tid=kmp[id-(id-kmp[id])*(xs[id]-1)];\r\n\t\t}\r\n\t\treturn ans;\r\n\t}\r\n}S1,S2;\r\n#define ll long long\r\nint gcd(int a,int b){\r\n\tif(!b)return a;\r\n\treturn gcd(b,a%b);\r\n}\r\nvoid exgcd(int a,int b,ll &x,ll &y){\r\n\tif(!b){x=1,y=0;return;}\r\n\texgcd(b,a%b,y,x),y-=x*(a/b);\r\n}\r\nll shang(ll a,ll b){\r\n\tif(a>0)return (a-1)/b+1;\r\n\treturn a/b;\r\n}\r\nll xia(ll a,ll b){\r\n\tif(a>0)return a/b;\r\n\treturn (a-1)/b+1;\r\n}\r\nint YHP(syz a,syz b,int n){\r\n\ta.y--,b.y--;\r\n\ta.x-=a.y*a.z,b.x-=b.y*b.z;\r\n\tn-=a.x+b.x;int gc=gcd(a.z,b.z);\r\n\tif(n<0||n%gc)return 0;\r\n\tif(!n)return 1;\r\n\tn/=gc,a.z/=gc,b.z/=gc;\r\n\tll x,y;exgcd(a.z,b.z,x,y);\r\n\tx*=n,y*=n;\r\n\tll L=max(shang(-x,b.z),shang(y-b.y,a.z)),R=min(xia(-x+a.y,b.z),xia(y,a.z));\r\n\treturn max(R-L+1,0ll);\r\n}\r\nint n,m,q;\r\nchar C[100100],bt[101000];\r\nvector<int>KOT[100100];\r\nint main(){\r\n\tE[0]=EI[0]=1;int Is=qpow(G,mod-2);\r\n\tfor(int i=1;i<=100000;i++)E[i]=1ll*E[i-1]*G%mod,EI[i]=1ll*EI[i-1]*Is%mod;\r\n\tT1.cn=T2.cn=1;\r\n\tscanf(\"%d%d%d\",&n,&m,&q);\r\n\tfor(int i=1,u,v;i<n;i++){\r\n\t\tscanf(\"%d%d%s\",&u,&v,C);\r\n\t\tg[u].push_back((ed){v,C[0]});\r\n\t\tg[v].push_back((ed){u,C[0]});\r\n\t}\r\n\tdfs(1);\r\n\tint ks=0;\r\n\tfor(int i=1;i<=m;i++){\r\n\t\tscanf(\"%s\",C+1);int Le=strlen(C+1);\r\n\t\tT1.init(id1[i],C,Le);\r\n\t\treverse(C+1,C+Le+1);\r\n\t\tT2.init(id2[i],C,Le);\r\n\t\treverse(C+1,C+Le+1);\r\n\t\tfor(int j=1;j<=Le;j++)bt[ks+j]=C[j];ks+=Le;\r\n\t\tL[i]=ks-Le+1,R[i]=ks;\r\n\t}\r\n\tT1.build(),T2.build();\r\n\tfor(int i=1;i<=q;i++){\r\n\t\tscanf(\"%d%d%d\",&U[i],&V[i],&W[i]);\r\n\t\tKOT[W[i]].push_back(i);\r\n\t\tlc[i]=lca(U[i],V[i]);int len=R[W[i]]-L[W[i]]+1;\r\n\t\tif(d[U[i]]-d[lc[i]]>=len)op[U[i]].push_back((com){i,2,1}),op[kth(U[i],d[U[i]]-d[lc[i]]-len+1)].push_back((com){i,2,-1});\r\n\t\tif(d[V[i]]-d[lc[i]]>=len)op[V[i]].push_back((com){i,1,1}),op[kth(V[i],d[V[i]]-d[lc[i]]-len+1)].push_back((com){i,1,-1});\r\n\t}\r\n\tdfs2(1,1,1);\r\n\tfor(int i=1;i<=m;i++){\r\n\t\tint Le=R[i]-L[i]+1;\r\n\t\tfor(int j=1;j<=Le;j++)C[j]=bt[j+L[i]-1];\r\n\t\tS1.init(C,Le),reverse(C+1,C+Le+1),S2.init(C,Le);\r\n\t\tfor(int j:KOT[i]){\r\n\t\t\tif(U[j]==lc[j]||V[j]==lc[j])continue;\r\n\t\t\tvector<syz>k1=S2.ask(U[j],lc[j]),k2=S1.ask(V[j],lc[j]);\r\n\t\t\tfor(syz v1:k1)for(syz v2:k2)ans[j]+=YHP(v1,v2,Le);\r\n\t\t}\r\n\t}\r\n\tfor(int i=1;i<=q;i++)printf(\"%d\\n\",ans[i]);\r\n    return 0;\r\n}"
}