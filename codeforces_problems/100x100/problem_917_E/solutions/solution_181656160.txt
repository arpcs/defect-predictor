{
    "id": 181656160,
    "contestId": 917,
    "creationTimeSeconds": 1668882130,
    "relativeTimeSeconds": 2147483647,
    "problem": {
        "contestId": 917,
        "index": "E",
        "name": "Upside Down",
        "type": "PROGRAMMING",
        "points": 2750.0,
        "rating": 3400,
        "tags": [
            "data structures",
            "string suffix structures",
            "strings",
            "trees"
        ]
    },
    "author": {
        "contestId": 917,
        "members": [
            {
                "handle": "f_a_y_zi"
            }
        ],
        "participantType": "PRACTICE",
        "ghost": false,
        "startTimeSeconds": 1517236500
    },
    "programmingLanguage": "GNU C++17",
    "verdict": "OK",
    "testset": "TESTS",
    "passedTestCount": 118,
    "timeConsumedMillis": 530,
    "memoryConsumedBytes": 155852800,
    "source": "// The first ac is O(n^2), but data is weak\r\n// O(n log^2)\r\n#include <iostream>\r\n#include <algorithm>\r\n#include<cmath>\r\n#include<cstring>\r\n#include<cstdio>\r\n#include<cstdlib>\r\n#include<vector>\r\n#include<iomanip>\r\n#include<ctime>\r\n#include<set>\r\n#include<map>\r\n#include<queue>\r\n#include<stack>\r\n#include<bitset>\r\n#include<cassert>\r\n#define sqr(x) ((x)*(x))\r\n#define fz1(i,n) for ((i)=1;(i)<=(n);(i)++)\r\n#define fd1(i,n) for ((i)=(n);(i)>=1;(i)--)\r\n#define fz0g(i,n) for ((i)=0;(i)<=(n);(i)++)\r\n#define fd0g(i,n) for ((i)=(n);(i)>=0;(i)--)\r\n#define fz0k(i,n) for ((i)=0;(i)<(n);(i)++)\r\n#define fd0k(i,n) for ((i)=(((long long)(n))-1);(i)>=0;(i)--)\r\n#define fz(i,x,y) for ((i)=(x);(i)<=(y);(i)++)\r\n#define fd(i,y,x) for ((i)=(y);(i)>=(x);(i)--)\r\n#define fzin fz1(i,n)\r\n#define fzim fz1(i,m)\r\n#define fzjn fz1(j,n)\r\n#define fzjm fz1(j,m)\r\n#define ff(c,itr) for (__typeof((c).begin()) itr=(c).begin();itr!=(c).end();++itr)\r\n#define pb push_back\r\n#define mk make_pair\r\n#define rdst(st,len){static char ss[len];scanf(\" %s\",ss);(st)=ss;}\r\n#define spln(i,n) (i==n?'\\n':' ')\r\n#define fac_init(n){fac[0]=fac[1]=inv[1]=fi[0]=fi[1]=1;fz(i,2,n){fac[i]=1ll*fac[i-1]*i%mod;inv[i]=1ll*(mod-mod/i)*inv[mod%i]%mod;fi[i]=1ll*fi[i-1]*inv[i]%mod;}}\r\nusing namespace std;\r\n/*#ifndef ONLINE_JUDGE\r\n\tFILE *___=freopen(\"1.in\",\"r\",stdin);\r\n#endif*/\r\n/*inline void read(int &x)\r\n{\r\n\tchar c;int f=1;\r\n\twhile(!isdigit(c=getchar()))if(c=='-')f=-1;\r\n\tx=(c&15);while(isdigit(c=getchar()))x=(x<<1)+(x<<3)+(c&15);\r\n\tx*=f;\r\n}*/\r\nconst int mod=1004535809,e1=189,e2=190;\r\nint n,m,q,i,j,k;\r\nint pw1[200005],pw2[200005];\r\nvoid init_pow()\r\n{\r\n\tint i;pw1[0]=pw2[0]=1;\r\n\tfz1(i,200002) pw1[i]=1ll*e1*pw1[i-1]%mod,pw2[i]=1ll*e2*pw2[i-1]%mod;\r\n}\r\nstruct strhsh\r\n{\r\n\tint h1[200005],h2[200005];\r\n\tstring st;int len;\r\n\tvoid init(string _)\r\n\t{\r\n\t\tst=_;len=st.size()-1;int i;\r\n\t\tfz1(i,len){\r\n\t\t\th1[i]=(1ll*h1[i-1]*e1+st[i])%mod;\r\n\t\t\th2[i]=(1ll*h2[i-1]*e2+st[i])%mod;\r\n\t\t}\r\n\t}\r\n\tpair<int,int> calc(int l,int r)\r\n\t{\r\n\t\treturn make_pair((h1[r]+1ll*(mod-h1[l-1])*pw1[r-l+1])%mod,(h2[r]+1ll*(mod-h2[l-1])*pw2[r-l+1])%mod);\r\n\t}\r\n};\r\nint fa[100005],tp[100005],dep[100005],sz[100005],dfn[100005],mp[100005],ti,son[100005];\r\nchar fv[100005];\r\nvector<pair<int,char> > bi1[100005];\r\nint px[100005],py[100005],pz[100005],ans[100005];\r\nstring st[100005];\r\nvoid dfs1(int x,int fa)\r\n{\r\n\t::fa[x]=fa;sz[x]=1;\r\n\tff(bi1[x],it)if(it->first!=fa){\r\n\t\tdep[it->first]=dep[x]+1;\r\n\t\tfv[it->first]=it->second;\r\n\t\tdfs1(it->first,x);\r\n\t\tsz[x]+=sz[it->first];\r\n\t\tif(sz[it->first]>sz[son[x]]) son[x]=it->first;\r\n\t}\r\n}\r\nvoid dfs2(int x,int t)\r\n{\r\n\tmp[dfn[x]=++ti]=x;\r\n\ttp[x]=t;if(son[x]) dfs2(son[x],t);\r\n\tff(bi1[x],it)if(it->first!=fa[x]&&it->first!=son[x]){\r\n\t\tdfs2(it->first,it->first);\r\n\t}\r\n}\r\nint lca(int x,int y)\r\n{\r\n\twhile(tp[x]!=tp[y]){\r\n\t\tif(dep[tp[x]]<dep[tp[y]]) swap(x,y);\r\n\t\tx=fa[tp[x]];\r\n\t}\r\n\treturn mp[min(dfn[x],dfn[y])];\r\n}\r\nint gtf(int x,int y)\r\n{\r\n\tint d=dep[x]-y;\r\n\twhile(dep[tp[x]]>d) x=fa[tp[x]];\r\n\treturn mp[dfn[x]-(dep[x]-d)];\r\n}\r\n \r\n// chu'li zhi'shang'zhi'xia de lian\r\nvector<pair<int,int> > vz[100005],vf[100005];\r\nstruct acam\r\n{\r\n\tint pos[100005],fi[100005],ed[100005],ti;\r\n\tint ch[100005][26],fail[100005],cnt=1;\r\n\tint c[100005];\r\n\tvector<int> bi2[100005];\r\n\tvoid add(int x,int y){while(x<=ti)c[x]+=y,x+=(x&-x);}\r\n\tint query(int x){int s=0;while(x)s+=c[x],x-=(x&-x);return s;}\r\n\tint query(int l,int r){return query(r)-query(l-1);}\r\n\tvoid ins(string st)\r\n\t{\r\n\t\tint x=1,i;\r\n\t\tfz0k(i,st.size()){\r\n\t\t\tif(!ch[x][st[i]-'a']) ch[x][st[i]-'a']=++cnt;\r\n\t\t\tx=ch[x][st[i]-'a'];\r\n\t\t}\r\n\t\tpos[::i]=x;\r\n\t}\r\n\tvoid dfs2(int x){fi[x]=++ti;ff(bi2[x],it)dfs2(*it);ed[x]=ti;}\r\n\tvoid rebuild()\r\n\t{\r\n\t\tqueue<int> qx;int i;qx.push(1);\r\n\t\twhile(!qx.empty()){\r\n\t\t\tint x=qx.front();qx.pop();\r\n\t\t\tfz0k(i,26)if(ch[x][i]){\r\n\t\t\t\tfail[ch[x][i]]=(x==1?1:ch[fail[x]][i]);\r\n\t\t\t\tqx.push(ch[x][i]);\r\n\t\t\t}\r\n\t\t\telse ch[x][i]=(x==1?1:ch[fail[x]][i]);\r\n\t\t}\r\n\t\tfz(i,2,cnt) bi2[fail[i]].push_back(i);\r\n\t\tdfs2(1); \r\n\t}\r\n}az,af;\r\nvoid dfs3(int x,int fa,int pz,int pf)\r\n{\r\n\taz.add(az.fi[pz],1);af.add(af.fi[pf],1);\r\n\tff(vz[x],it) ans[it->first]+=it->second*az.query(az.fi[az.pos[::pz[it->first]]],az.ed[az.pos[::pz[it->first]]]);\r\n\tff(vf[x],it) ans[it->first]+=it->second*af.query(af.fi[af.pos[::pz[it->first]]],af.ed[af.pos[::pz[it->first]]]);\r\n\tff(bi1[x],it)if(it->first!=fa) dfs3(it->first,x,az.ch[pz][it->second-'a'],af.ch[pf][it->second-'a']);\r\n\taz.add(az.fi[pz],-1);af.add(af.fi[pf],-1);\r\n}\r\n \r\n// ji'suan zui'chang pi'pei de qian'zhui/hou'zhui\r\nvector<int> vq[100005];\r\nint znxt[100005],fnxt[100005];\r\nstruct sam\r\n{\r\n\tint fa[200005],l[200005],ch[200005][26],ed[200005],cnt,lst;\r\n\tchar fr[200005];\r\n\tvector<int> bi1[200005];\r\n\tvoid init(){while(cnt){bi1[cnt].clear();memset(ch[cnt],0,sizeof(ch[cnt]));cnt--;}cnt=lst=1;fr[1]='%';ed[1]=0;}\r\n\tvoid extend(char c,int id)\r\n\t{\r\n\t\tint np=++cnt,p=lst;lst=np;l[np]=l[p]+1;ed[np]=id;fr[np]=c;\r\n\t\tfor(;p&&!ch[p][c-'a'];p=fa[p]) ch[p][c-'a']=np;\r\n\t\tif(!p){fa[np]=1;return;}int q=ch[p][c-'a'];\r\n\t\tif(l[p]+1==l[q]){fa[np]=q;return;}int nq=++cnt;ed[nq]=0;fr[nq]=fr[q];\r\n\t\tfa[nq]=fa[q];fa[q]=fa[np]=nq;l[nq]=l[p]+1;\r\n\t\tmemcpy(ch[nq],ch[q],sizeof(ch[q]));\r\n\t\tfor(;p&&ch[p][c-'a']==q;p=fa[p]) ch[p][c-'a']=nq;\r\n\t}\r\n\tvoid dfs0(int x)\r\n\t{\r\n\t\tff(bi1[x],it){\r\n\t\t\tdfs0(*it);\r\n\t\t\tif(!ed[x]) ed[x]=ed[*it];\r\n\t\t}\r\n\t}\r\n\tvector<int> bi2[200005];\r\n\tint ord[200005];\r\n\tint son[200005],bel[200005],mp[200005],dfn[200005],dfe[200005],ti;\r\n\tlong long f[200005],g[200005];\r\n\tvoid decomposs()\r\n\t{\r\n\t\tint i,j;fz1(i,cnt)ord[i]=i,bi2[i].clear();\r\n\t\tsort(ord+1,ord+cnt+1,[&](int x,int y){return l[x]<l[y];});\r\n\t\tfz1(i,cnt)fz0k(j,26)if(ch[i][j]) bi2[i].push_back(ch[i][j]);\r\n\t\tti=0;fz1(i,cnt) f[i]=g[i]=son[i]=bel[i]=mp[i]=dfn[i]=dfe[i]=0;\r\n\t\tfz1(i,cnt){\r\n\t\t\tint x=ord[i];f[x]++;\r\n\t\t\tff(bi2[x],it) f[*it]+=f[x];\r\n\t\t}\r\n\t\tfd1(i,cnt){\r\n\t\t\tint x=ord[i];g[x]=1;\r\n\t\t\tff(bi2[x],it) g[x]+=g[*it];\r\n\t\t\tff(bi2[x],it) if(f[x]*2>f[*it]&&g[*it]*2>g[x]) son[x]=*it;\r\n\t\t}\r\n\t\tfz1(i,cnt){\r\n\t\t\tint x=ord[i];if(bel[x])continue;\r\n\t\t\tfor(j=x;j;j=son[j]) bel[mp[dfn[j]=++ti]=j]=x;\r\n\t\t\tdfe[x]=ti;\r\n\t\t}\r\n\t}\r\n\tstrhsh h;\r\n\tvoid build(string st)\r\n\t{\r\n\t\tinit();int i;fz1(i,st.size()-1) extend(st[i],i);\r\n\t\tfz(i,2,cnt) bi1[fa[i]].push_back(i);\r\n\t\tdfs0(1);\r\n\t\tdecomposs();\r\n\t\tstring tmp=\" \";\r\n\t\tfz1(i,ti) tmp+=fr[mp[i]];\r\n\t\th.init(tmp);\r\n\t}\r\n}dz,df;\r\nstrhsh hz,hf;\r\nint len;\r\nstruct border_tree\r\n{\r\n\tint len,fa[100005];\r\n\tvector<int> bi[100005];\r\n\tint tp[100005],dep[100005],sz[100005],dfn[100005],dfe[100005],mp[100005],ti,son[100005];\r\n\tvoid dfs1(int x)\r\n\t{\r\n\t\tsz[x]=1;son[x]=0;\r\n\t\tff(bi[x],it){\r\n\t\t\tdep[*it]=dep[x]+1;dfs1(*it);\r\n\t\t\tsz[x]+=sz[*it];\r\n\t\t\tif(sz[*it]>sz[son[x]]) son[x]=*it;\r\n\t\t}\r\n\t}\r\n\tvoid dfs2(int x,int t)\r\n\t{\r\n\t\tmp[dfn[x]=++ti]=x;tp[x]=t;if(son[x]) dfs2(son[x],t);\r\n\t\tff(bi[x],it)if(*it!=son[x]) dfs2(*it,*it);\r\n\t\tdfe[x]=ti;\r\n\t}\r\n\tvoid build(int _,int *a)\r\n\t{\r\n\t\tlen=_;int i;fz1(i,len) fa[i]=a[i];\r\n\t\tfz0g(i,len) bi[i].clear();fz1(i,len) bi[fa[i]].push_back(i);\r\n\t\tti=0;dfs1(0);dfs2(0,0);\r\n\t}\r\n\tint query(int x,int lim)\r\n\t{\r\n\t\twhile(tp[x]>lim) x=fa[tp[x]];\r\n\t\tint l=dfn[tp[x]]+1,r=dfn[x]+1,res=tp[x],mid;\r\n\t\twhile(l<r){\r\n\t\t\tmid=(l+r)/2;\r\n\t\t\tif(mp[mid]<=lim) l=mid+1,res=mp[mid];\r\n\t\t\telse r=mid;\r\n\t\t}\r\n\t\treturn res;\r\n\t}\r\n}tz,tf;\r\nint calc(strhsh &a,strhsh &b,int x,int y,int len)\r\n{\r\n\tint i;for(i=0;i<10&&i<len;i++) if(a.st[x+i]!=b.st[y+i])break;\r\n\tif(i<10) return i;\r\n\tint ans=i,l=i+1,r=len+1,mid;\r\n\twhile(l<r){\r\n\t\tmid=(l+r)/2;\r\n\t\tif(a.calc(x,x+mid-1)==b.calc(y,y+mid-1)) l=mid+1,ans=mid;\r\n\t\telse r=mid;\r\n\t}\r\n\treturn ans;\r\n}\r\nint transform_left(int x,int lim)\r\n{\r\n/*\t// bf:\r\n\tvector<char> v;\r\n\tint p=1,ml=0;\r\n\twhile(x!=lim) v.push_back(fv[x]),x=fa[x];\r\n\treverse(v.begin(),v.end());\r\n\tff(v,it){\r\n\t\tif(df.ch[p][*it-'a']) p=df.ch[p][*it-'a'],ml++;\r\n\t\telse break;\r\n\t}*/\r\n\t\r\n\tint p=1,ml=0;\r\n\tvector<int> vtp;\r\n\tint y=x;while(tp[y]!=tp[lim]) vtp.push_back(tp[y]),y=fa[tp[y]];\r\n\tfor(y=lim;y!=x;){\r\n\t\tif(!vtp.empty()&&fa[vtp.back()]==y){\r\n\t\t\tint ny=vtp.back();vtp.pop_back();\r\n\t\t\tif(df.ch[p][fv[ny]-'a']) p=df.ch[p][fv[ny]-'a'],ml++; else break;\r\n\t\t\ty=ny;continue;\r\n\t\t}\r\n\t\tint lcp=df.dfe[df.bel[p]]-df.dfn[p];\r\n\t\tlcp=min(lcp,vtp.empty()?dep[x]-dep[y]:dep[fa[vtp.back()]]-dep[y]);\r\n\t\tlcp=calc(hz,df.h,dfn[y]+1,df.dfn[p]+1,lcp);\r\n\t\tif(lcp==0){\r\n\t\t\tint ny=mp[dfn[y]+1];\r\n\t\t\tif(df.ch[p][fv[ny]-'a']) p=df.ch[p][fv[ny]-'a'],ml++; else break;\r\n\t\t\ty=ny;continue;\r\n\t\t}\r\n\t\ty=mp[dfn[y]+lcp];p=df.mp[df.dfn[p]+lcp];ml+=lcp;\r\n\t}\r\n \r\n\tint l=len-df.ed[p]+1,r=l+ml-1;\r\n\treturn tz.query(r,ml);\r\n}\r\nint transform_right(int x,int lim)\r\n{\r\n/*\t// bf:\r\n\tvector<char> v;\r\n\tint p=1,ml=0;\r\n\twhile(x!=lim) v.push_back(fv[x]),x=fa[x];\r\n\treverse(v.begin(),v.end());\r\n\tff(v,it){\r\n\t\tif(dz.ch[p][*it-'a']) p=dz.ch[p][*it-'a'],ml++;\r\n\t\telse break;\r\n\t}*/\r\n \r\n\tint p=1,ml=0;\r\n\tvector<int> vtp;\r\n\tint y=x;while(tp[y]!=tp[lim]) vtp.push_back(tp[y]),y=fa[tp[y]];\r\n\tfor(y=lim;y!=x;){\r\n\t\tif(!vtp.empty()&&fa[vtp.back()]==y){\r\n\t\t\tint ny=vtp.back();vtp.pop_back();\r\n\t\t\tif(dz.ch[p][fv[ny]-'a']) p=dz.ch[p][fv[ny]-'a'],ml++; else break;\r\n\t\t\ty=ny;continue;\r\n\t\t}\r\n\t\tint lcp=dz.dfe[dz.bel[p]]-dz.dfn[p];\r\n\t\tlcp=min(lcp,vtp.empty()?dep[x]-dep[y]:dep[fa[vtp.back()]]-dep[y]);\r\n\t\tlcp=calc(hz,dz.h,dfn[y]+1,dz.dfn[p]+1,lcp);\r\n\t\tif(lcp==0){\r\n\t\t\tint ny=mp[dfn[y]+1];\r\n\t\t\tif(dz.ch[p][fv[ny]-'a']) p=dz.ch[p][fv[ny]-'a'],ml++; else break;\r\n\t\t\ty=ny;continue;\r\n\t\t}\r\n\t\ty=mp[dfn[y]+lcp];p=dz.mp[dz.dfn[p]+lcp];ml+=lcp;\r\n\t}\r\n \r\n\tint r=dz.ed[p],l=r-ml+1;\r\n\treturn tf.query(len-l+1,ml);\r\n}\r\n \r\n// er'wei shu'dian he'bing border lian\r\nvector<pair<int,int> > tq[100005];\r\nstruct bit\r\n{\r\n\tint len,a[100005];\r\n\tvoid init(int _){len=_+1;int i;fz1(i,len)a[i]=0;}\r\n\tvoid add(int x,int c){while(x<=len) a[x]+=c,x+=(x&-x);}\r\n\tvoid add(int l,int r,int c){add(l,c);add(r+1,-c);}\r\n\tint query(int x){int s=0;while(x) s+=a[x],x-=(x&-x);return s;}\r\n}bt;\r\nvoid dfs4(int x)\r\n{\r\n\tbt.add(tf.dfn[len-x],tf.dfe[len-x],1);\r\n\tff(tq[x],it) ans[it->first]+=bt.query(tf.dfn[it->second]);\r\n\tff(tz.bi[x],it) dfs4(*it);\r\n\tbt.add(tf.dfn[len-x],tf.dfe[len-x],-1);\r\n}\r\n \r\nint main()\r\n{\r\n\tios_base::sync_with_stdio(0);\r\n\tinit_pow();\r\n\tcin>>n>>m>>q;\r\n\tfz1(i,n-1){\r\n\t\tint x,y;char c;cin>>x>>y>>c;\r\n\t\tbi1[x].push_back(make_pair(y,c));\r\n\t\tbi1[y].push_back(make_pair(x,c));\r\n\t}\r\n\tfz1(i,m){\r\n\t\tcin>>st[i];\r\n\t\taz.ins(st[i]);reverse(st[i].begin(),st[i].end());\r\n\t\taf.ins(st[i]);reverse(st[i].begin(),st[i].end());\r\n\t}\r\n\taz.rebuild();af.rebuild();\r\n\tdfs1(1,0);dfs2(1,1);\r\n\tstring tmp=\" \";fv[1]='^';\r\n\tfz1(i,ti) tmp.push_back(fv[mp[i]]);\r\n\thz.init(tmp);reverse(tmp.begin()+1,tmp.end());hf.init(tmp);\r\n\tfz1(i,q){\r\n\t\tcin>>px[i]>>py[i]>>pz[i];\r\n\t\tint z=lca(px[i],py[i]);\r\n\t\tif(dep[px[i]]-dep[z]>=st[pz[i]].size()){\r\n\t\t\tvf[px[i]].push_back(make_pair(i,1));\r\n\t\t\tvf[px[i]=gtf(px[i],dep[px[i]]-dep[z]-st[pz[i]].size()+1)].push_back(make_pair(i,-1));\r\n\t\t}\r\n\t\tif(dep[py[i]]-dep[z]>=st[pz[i]].size()){\r\n\t\t\tvz[py[i]].push_back(make_pair(i,1));\r\n\t\t\tvz[py[i]=gtf(py[i],dep[py[i]]-dep[z]-st[pz[i]].size()+1)].push_back(make_pair(i,-1));\r\n\t\t}\r\n\t\tvq[pz[i]].push_back(i);\r\n\t}\r\n\tdfs3(1,0,1,1);\r\n \r\n\tfz1(i,m)if(!vq[i].empty()){\r\n\t\tlen=st[i].size();st[i]=\" \"+st[i];\r\n\t\tdz.build(st[i]);\r\n\t\tznxt[1]=k=0;\r\n\t\tfz(j,2,len){\r\n\t\t\twhile(k&&st[i][j]!=st[i][k+1]) k=znxt[k];\r\n\t\t\tif(st[i][j]==st[i][k+1])k++;znxt[j]=k;\r\n\t\t}\r\n\t\ttz.build(len,znxt);\r\n\t\treverse(st[i].begin()+1,st[i].end());\r\n \r\n\t\tdf.build(st[i]);\r\n\t\tfnxt[1]=k=0;\r\n\t\tfz(j,2,len){\r\n\t\t\twhile(k&&st[i][j]!=st[i][k+1]) k=fnxt[k];\r\n\t\t\tif(st[i][j]==st[i][k+1])k++;fnxt[j]=k;\r\n\t\t}\r\n\t\ttf.build(len,fnxt);\r\n\t\treverse(st[i].begin()+1,st[i].end());\r\n \r\n\t\tfz0g(j,len) tq[j].clear();bt.init(len);\r\n\t\tff(vq[i],it){\r\n\t\t\tint z=lca(px[*it],py[*it]);\r\n\t\t\tint sl=transform_left(px[*it],z);\r\n\t\t\tint sr=transform_right(py[*it],z);\r\n\t\t\ttq[sl].push_back(make_pair(*it,sr));\r\n\t\t}\r\n\t\tdfs4(0);\r\n\t}\r\n \r\n\tfz1(i,q) printf(\"%d\\n\",ans[i]);\r\n\treturn 0;\r\n}"
}